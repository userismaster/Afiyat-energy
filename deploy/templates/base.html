{% load static %}
<!DOCTYPE html>
<html lang="{{ current_language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Afiyat Energy{% endblock %}</title>
    
    <!-- Основные стили -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Наши стили -->
    <link rel="stylesheet" href="{% static 'css/variables.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/transitions.css' %}">
    <link rel="stylesheet" href="{% static 'css/language-switcher.css' %}">
    <link rel="stylesheet" href="{% static 'css/header.css' %}">

    <style>
        :root {
            /* Основные цвета */
            --primary-color: #2C3E50;
            --secondary-color: #34495E;
            --accent-color: #3498DB;
            
            /* Текстовые цвета */
            --text-color: #2C3E50;
            --text-muted: #7F8C8D;
            
            /* Фоновые цвета */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            
            /* Границы */
            --border-color: #E9ECEF;
            --border-radius-sm: 0.25rem;
            --border-radius-lg: 0.5rem;
            
            /* RGB значения для использования в rgba */
            --primary-color-rgb: 44, 62, 80;
            --secondary-color-rgb: 52, 73, 94;
            --accent-color-rgb: 52, 152, 219;
        }

        body {
            color: var(--text-color);
            background-color: var(--bg-secondary);
        }

        /* Общие стили для всех страниц */
        .section-title {
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        .card {
            border: none;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        }

        .btn {
            border-radius: var(--border-radius-sm);
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Анимации */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
        
        :root {
            --primary-color: #28a745;
            --primary-dark: #218838;
            --primary-light: #34ce57;
            --text-color: #333;
            --border-color: #dee2e6;
        }
        
        body {
            background-color: #ffffff !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .text-primary {
            color: var(--primary-color) !important;
        }
        
        a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        a:hover {
            color: var(--primary-dark);
        }

        /* Переопределение цветов Bootstrap */
        :root {
            --bs-primary: var(--primary-color);
            --bs-primary-rgb: 39, 174, 96;
        }

        .btn-primary {
            --bs-btn-bg: var(--primary-color);
            --bs-btn-border-color: var(--primary-color);
            --bs-btn-hover-bg: var(--primary-dark);
            --bs-btn-hover-border-color: var(--primary-dark);
            --bs-btn-active-bg: var(--primary-dark);
            --bs-btn-active-border-color: var(--primary-dark);
        }

        .btn-outline-primary {
            --bs-btn-color: var(--primary-color);
            --bs-btn-border-color: var(--primary-color);
            --bs-btn-hover-bg: var(--primary-color);
            --bs-btn-hover-border-color: var(--primary-color);
            --bs-btn-active-bg: var(--primary-color);
            --bs-btn-active-border-color: var(--primary-color);
        }

        .nav-link {
            color: var(--text-color);
            transition: color var(--transition-base);
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary-color);
        }

        .dropdown-item:active {
            background-color: var(--primary-color);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(39, 174, 96, 0.25);
        }

        /* Кастомные стили */
        .social-links a {
            transition: color var(--transition-base);
        }

        .social-links a:hover {
            color: var(--primary-color) !important;
        }

        .cart-counter {
            background-color: var(--primary-color) !important;
        }

        /* Стили навигации */
        .navbar .nav-link {
            color: var(--text-color) !important;
        }

        .navbar .nav-link:hover,
        .navbar .nav-link.active {
            color: var(--primary-color) !important;
        }

        .navbar .nav-link::after {
            background-color: var(--primary-color) !important;
        }

        /* Стили корзины */
        .cart-icon {
            display: flex;
            align-items: center;
        }

        .cart-icon .btn-link {
            color: inherit;
            text-decoration: none;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cart-icon .fa-shopping-cart {
            font-size: 1.2rem;
        }

        .cart-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
            padding: 0 0.4rem;
            font-size: 0.8rem;
            font-weight: 500;
            line-height: 1;
            background-color: var(--primary-color);
            color: white;
            border-radius: 1rem;
        }

        /* Стили переключателя языков */
        .language-switcher .dropdown-toggle {
            background: none;
            border: none;
            color: inherit;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            padding: 0.5rem;
            gap: 0.5rem;
        }

        .language-switcher .dropdown-toggle::after {
            display: none !important;
        }

        .language-switcher .dropdown-toggle i {
            margin-right: 0.25rem;
        }

        .language-switcher .dropdown-toggle span {
            margin-right: 0.25rem;
        }

        .language-switcher .dropdown-toggle:after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 0.25rem;
            border-top: 0.3em solid;
            border-right: 0.3em solid transparent;
            border-bottom: 0;
            border-left: 0.3em solid transparent;
        }

        .language-switcher .dropdown-menu {
            min-width: 120px;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
        }

        .language-switcher .dropdown-item {
            padding: 0.5rem 1rem;
        }

        .fa-shopping-cart {
            font-size: 1.2rem;
        }

        /* Стили для переключателя языков */
        .language-switcher {
            margin-right: 1rem;
        }
        
        .language-switcher .btn-link {
            color: inherit;
            text-decoration: none;
            padding: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .language-switcher .dropdown-toggle::after {
            margin-left: 0.5rem;
        }
        
        /* Стили для корзины */
        .cart-icon {
            margin-left: 0.5rem;
        }
        
        .cart-icon .btn-link {
            color: inherit;
            padding: 0.5rem;
            text-decoration: none;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .cart-icon .fa-shopping-cart {
            font-size: 1.2rem;
        }
        
        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            font-size: 0.75rem;
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
        }

        /* Стили для переключателя языков */
        .language-switcher .btn-link {
            color: inherit;
            text-decoration: none;
            padding: 0.5rem;
        }
        
        .language-switcher .btn-link:after {
            display: inline-block;
            margin-left: 0.5rem;
            content: "";
            border-top: 0.3em solid;
            border-right: 0.3em solid transparent;
            border-bottom: 0;
            border-left: 0.3em solid transparent;
            vertical-align: middle;
        }
        
        /* Стили для корзины */
        .cart-icon {
            margin-left: 0.5rem;
            position: relative;
        }
        
        .cart-icon .btn-link {
            color: inherit;
            padding: 0.5rem;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        
        .cart-icon .fa-shopping-cart {
            font-size: 1.2rem;
        }
        
        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(25%, -25%);
            font-size: 0.75rem;
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            z-index: 1;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Навигация -->
    <header class="header">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="{% url 'catalog:home' %}">
                    <img src="{% static 'images/logo.png' %}" alt="Afiyat Energy" height="40">
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'catalog:home' %}">{{ translations.nav.home }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'catalog:about' %}">{{ translations.nav.about }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'catalog:product_list' %}">{{ translations.nav.catalog }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'catalog:blog' %}">{{ translations.nav.blog }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'contacts:contact' %}">{{ translations.nav.contacts }}</a>
                        </li>
                    </ul>

                    <div class="header-actions d-flex align-items-center">
                        <!-- Телефон -->
                        <div class="contact-phone me-4">
                            <a href="tel:+998999999999" class="d-flex align-items-center">
                                <i class="fas fa-phone me-2"></i>
                                <span>+998 99 999 99 99</span>
                            </a>
                        </div>
                        
                        <!-- Language Switcher -->
                        <div class="language-switcher me-4">
                            <div class="dropdown">
                                <button class="dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-globe"></i>
                                    <span>{{ current_language|upper }}</span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                                    <li><a class="dropdown-item {% if current_language == 'ru' %}active{% endif %}" href="{% url 'change_language' %}?lang=ru">Русский</a></li>
                                    <li><a class="dropdown-item {% if current_language == 'en' %}active{% endif %}" href="{% url 'change_language' %}?lang=en">English</a></li>
                                    <li><a class="dropdown-item {% if current_language == 'uz' %}active{% endif %}" href="{% url 'change_language' %}?lang=uz">O'zbekcha</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- Cart Icon -->
                        <div class="cart-icon">
                            <a href="{% url 'catalog:cart' %}" class="btn btn-link">
                                <i class="fas fa-shopping-cart"></i>
                                {% if cart_count > 0 %}
                                <div class="cart-count">{{ cart_count }}</div>
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Основной контент -->
    <main class="page-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Подвал -->
    <footer class="footer bg-dark text-light py-5 mt-5">
        <div class="container">
            <div class="row g-4">
                <!-- Информация о компании -->
                <div class="col-lg-4">
                    <h5 class="mb-4">{{ translations.footer.about.title }}</h5>
                    <p>{{ translations.footer.about.description }}</p>
                </div>

                <!-- Быстрые ссылки -->
                <div class="col-lg-4">
                    <h5 class="mb-4">{{ translations.footer.navigation.title }}</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="{% url 'catalog:about' %}" class="text-light text-decoration-none">{{ translations.footer.navigation.about }}</a></li>
                        <li class="mb-2"><a href="{% url 'catalog:product_list' %}" class="text-light text-decoration-none">{{ translations.footer.navigation.catalog }}</a></li>
                        <li class="mb-2"><a href="{% url 'catalog:blog' %}" class="text-light text-decoration-none">{{ translations.footer.navigation.blog }}</a></li>
                        <li class="mb-2"><a href="{% url 'contacts:contact' %}" class="text-light text-decoration-none">{{ translations.footer.navigation.contacts }}</a></li>
                    </ul>
                </div>

                <!-- Контакты -->
                <div class="col-lg-4">
                    <h5 class="mb-4">{{ translations.footer.contacts.title }}</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            {{ translations.footer.contacts.address }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-phone me-2"></i>
                            <a href="tel:{{ translations.footer.contacts.phone }}" class="text-light text-decoration-none">{{ translations.footer.contacts.phone }}</a>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-envelope me-2"></i>
                            <a href="mailto:{{ translations.footer.contacts.email }}" class="text-light text-decoration-none">{{ translations.footer.contacts.email }}</a>
                        </li>
                    </ul>

                    <!-- Социальные сети -->
                    <div class="social-links mt-4">
                        <a href="#" class="text-light me-3" title="{{ translations.footer.social.facebook }}"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-light me-3" title="{{ translations.footer.social.telegram }}"><i class="fab fa-telegram"></i></a>
                        <a href="#" class="text-light" title="{{ translations.footer.social.instagram }}"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>

            <!-- Копирайт -->
            <div class="border-top border-secondary pt-4 mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-0">&copy; {% now "Y" %} Afiyat Energy. {{ translations.footer.copyright.rights }}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-0">{{ translations.footer.copyright.developed }} <i class="fas fa-heart text-danger"></i> {{ translations.footer.copyright.team }}</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Функции для работы с корзиной -->
    <script>
        function showCartToast(productName, quantity, totalPrice) {
            console.log('Showing cart toast:', { productName, quantity, totalPrice });
            Toastify({
                node: (() => {
                    const node = document.createElement("div");
                    node.innerHTML = `
                        <div class="cart-toast-content">
                            <i class="fas fa-check-circle cart-toast-icon"></i>
                            <div class="cart-toast-message">
                                <strong>${productName}</strong> добавлен в корзину<br>
                                <small>Количество: ${quantity}, Сумма: ${totalPrice} UZS</small>
                            </div>
                            <i class="fas fa-times cart-toast-close"></i>
                        </div>
                        <div class="cart-toast-actions">
                            <a href="{% url 'catalog:cart' %}" class="cart-toast-button cart-toast-view">
                                Просмотр корзины
                            </a>
                            <a href="{% url 'catalog:checkout' %}" class="cart-toast-button cart-toast-checkout">
                                Оформить заказ
                            </a>
                        </div>
                    `;
                    
                    // Добавляем обработчик для кнопки закрытия
                    const closeBtn = node.querySelector('.cart-toast-close');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', function() {
                            const toastElement = this.closest('.cart-toast').parentElement;
                            if (toastElement) {
                                toastElement.remove();
                            }
                        });
                    }
                    
                    return node;
                })(),
                className: "cart-toast",
                duration: 5000,
                newWindow: true,
                close: false,
                gravity: "top",
                position: "right",
                stopOnFocus: true,
                style: {
                    background: "transparent",
                    boxShadow: "none"
                }
            }).showToast();
        }

        // Обработчик добавления в корзину
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing cart handlers');
            
            const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
            console.log('Found add-to-cart buttons:', addToCartButtons.length);
            
            addToCartButtons.forEach(button => {
                console.log('Button data:', {
                    productId: button.dataset.productId,
                    productName: button.dataset.productName,
                    productPrice: button.dataset.productPrice
                });
                
                button.addEventListener('click', function(e) {
                    console.log('Add to cart button clicked');
                    e.preventDefault();
                    
                    const productId = this.dataset.productId;
                    const productName = this.dataset.productName;
                    const productPrice = this.dataset.productPrice;
                    let quantity = 1;
                    
                    // Проверяем, есть ли поле ввода количества
                    const quantityInput = document.querySelector('input[name="quantity"]');
                    if (quantityInput) {
                        quantity = parseInt(quantityInput.value) || 1;
                    }
                    
                    console.log('Adding to cart:', {
                        productId,
                        productName,
                        productPrice,
                        quantity
                    });
                    
                    // Данные для отправки
                    const data = {
                        product_id: productId,
                        quantity: quantity
                    };
                    
                    // Получаем CSRF токен
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    console.log('CSRF Token:', csrfToken);
                    
                    // Отправляем запрос
                    fetch('{% url "catalog:cart_add" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        console.log('Response received:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Data received:', data);
                        if (data.success) {
                            // Обновляем счетчик корзины
                            const cartCount = document.getElementById('cart-count');
                            if (cartCount) {
                                cartCount.textContent = data.cart_count;
                            }
                            
                            // Показываем уведомление
                            const totalPrice = (parseFloat(productPrice) * quantity).toLocaleString('ru-RU');
                            showCartToast(productName, quantity, totalPrice);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Ошибка',
                                text: data.error || 'Произошла ошибка при добавлении товара в корзину',
                                confirmButtonColor: var(--primary-color)
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Ошибка',
                            text: 'Произошла ошибка при добавлении товара в корзину',
                            confirmButtonColor: var(--primary-color)
                        });
                    });
                });
            });
        });
    </script>

    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/transitions.js' %}"></script>
    
    {% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
                Swal.fire({
                    title: '{% if message.tags == "success" %}Успешно!{% elif message.tags == "error" %}Ошибка!{% else %}{{ message.tags|title }}{% endif %}',
                    text: '{{ message }}',
                    icon: '{% if message.tags == "error" %}error{% else %}{{ message.tags }}{% endif %}',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#28a745',
                    customClass: {
                        popup: 'animated fadeInDown faster'
                    }
                });
            {% endfor %}
        });
    </script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
</body>
</html>
